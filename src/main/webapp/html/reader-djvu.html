<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>DJVU reader</title>
		<link rel="stylesheet" type="text/css" href="css/reader-djvu.css"/>
	</head>
    <header>
        <script src="js/djvu.js"></script>
        <script src="js/djvu_viewer.js"></script>
        <script src="js/elib.routes.js"></script>
        <script>
            var urlString = window.location.href;
            var url = new URL(urlString);
            var bookId = url.searchParams.get("id");
            let currentPage = 1;

            async function loadDocument() {
                const viewer = new DjVu.Viewer();
                viewer.render(document.getElementById('for_viewer'));
                await viewer.loadDocumentByUrl(router.getBook(bookId));

                viewer.configure({
                    pageNumber: currentPage,
                });

                viewer.on(DjVu.Viewer.Events.PAGE_NUMBER_CHANGED, () => { // no args are passed here
                    console.log('Page number changed to', viewer.getPageNumber());
                    currentPage = viewer.getPageNumber();
                    let pathToPost = router.getBookPageHistory(bookId);
            		let xhr = new XMLHttpRequest();
            		xhr.open("POST", pathToPost, true);
            		xhr.setRequestHeader('Content-Type', 'application/json');
            			xhr.send(JSON.stringify({
            			    page: currentPage - 1
            		}));
                })
            }

         // Get last opened page for the book
            window.onload = function() {
            	let pageReq = new XMLHttpRequest();
        		pageReq.open("GET", router.getBookLastPage(bookId), true);
        		pageReq.setRequestHeader('Content-Type', 'application/json');
        		pageReq.onload = function() {
        			currentPage = parseInt(pageReq.response) + 1;
        			createStamp();
        			loadDocument();
        		};
        		pageReq.send('page-info'); 
        		
        		let createStamp = function() {
            		let pathToPost = router.getBookHistory();
            		var xhr = new XMLHttpRequest();
            		xhr.open("POST", pathToPost, true);
            		xhr.setRequestHeader('Content-Type', 'application/json');
            			xhr.send(JSON.stringify({
            				id: bookId,
            				page: currentPage
            			}));
            		}
        		
                window.ViewerInstance = new DjVu.Viewer();
                window.ViewerInstance.render(
                    document.querySelector("#for_viewer")
                );
                
            };
            
            // Bookmarks menu
            function openNav() {
       	     document.getElementById("mySidenav").style.width = "250px";
       	   }
       	
       	   function closeNav() {
       	     document.getElementById("mySidenav").style.width = "0";
       	   }
       	   
       		
	       	function showModalInput() {
	       		let modalDlg = document.getElementById("modalDialogue");
	       		console.log(modalDlg);
	       		modalDlg.style.display = "block";
	       	}
	       	
	       	function hideModalInput() {
	       		let modalDlg = document.getElementById("modalDialogue");
	       		console.log(modalDlg);
	       		modalDlg.style.display = "none";
	       	}
	       	
        </script>
    </header>

    <body>
    	<div class="bookmarksButton">
    		<a href="#" onclick="openNav()">Bookmarks</a>
    	</div>
    	<div id="mySidenav" class="sidenav">
		  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
		  <a href="#" class="bookmarkCreator" onclick="showModalInput()">Create</a>
	 	</div>
        <div id="for_viewer"></div>
        
	  <!-- Modal dialogue -->
	  <div id="modalDialogue" class="modalDialogue">
	  	<div class="modal-content">
			<span class="close" onclick="hideModalInput()">&times;</span>
			<p>Some text in the Modal..</p>
		</div>
	  </div>

    </body>
</html>